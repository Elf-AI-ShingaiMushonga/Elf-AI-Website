{% extends "internal/base.html" %}

{% block title %}To-Do Board | ELF-AI Internal{% endblock %}

{% macro render_nested_task(task, view_mode, project_scope, depth=0) %}
<li class="space-y-2">
    <article class="rounded-xl border border-slate-800 bg-slate-950/80 p-4 card-hover {% if task.is_done %}opacity-70{% endif %}" style="margin-left: {{ depth * 1.05 }}rem;">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-3">
            <div>
                <p class="text-white font-semibold">
                    {% if task.parent_task_id %}
                    <i class="fa-solid fa-turn-up text-slate-500 mr-1"></i>
                    {% endif %}
                    {{ task.title }}
                </p>
                <p class="text-xs text-slate-400 mt-1">
                    {{ task.project.name }} · {{ task.assignee }}
                    {% if task.due_date %}
                    · Due {{ task.due_date.strftime('%d %b %Y') }}
                    {% endif %}
                </p>
            </div>

            <div class="flex flex-wrap items-center gap-2">
                <span class="text-xs px-2.5 py-1 rounded-full {{ internal_priority_class(task.priority) }} bg-slate-900 border border-slate-700">{{ task.priority|title }}</span>
                <span class="text-xs px-2.5 py-1 rounded-full {{ internal_status_class(task.status) }}">{{ task.status|replace('-', ' ')|title }}</span>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-2 mt-3">
            <form action="{{ url_for('main.internal_todo_update_status', task_id=task.id) }}" method="post" class="flex gap-2">
                <input type="hidden" name="view_mode" value="{{ view_mode }}">
                <input type="hidden" name="project_scope" value="{{ project_scope if project_scope else '' }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label class="sr-only" for="task-status-{{ task.id }}">Update status</label>
                <select id="task-status-{{ task.id }}" name="status" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-200 focus:outline-none focus:border-blue-500 transition">
                    <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>Todo</option>
                    <option value="in-progress" {% if task.status == 'in-progress' %}selected{% endif %}>In Progress</option>
                    <option value="blocked" {% if task.status == 'blocked' %}selected{% endif %}>Blocked</option>
                    <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
                </select>
                <button type="submit" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs font-semibold text-slate-100 transition">Status</button>
            </form>

            <form action="{{ url_for('main.internal_todo_update_priority', task_id=task.id) }}" method="post" class="flex gap-2">
                <input type="hidden" name="view_mode" value="{{ view_mode }}">
                <input type="hidden" name="project_scope" value="{{ project_scope if project_scope else '' }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label class="sr-only" for="task-priority-{{ task.id }}">Update priority</label>
                <select id="task-priority-{{ task.id }}" name="priority" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-200 focus:outline-none focus:border-blue-500 transition">
                    <option value="high" {% if task.priority == 'high' %}selected{% endif %}>High</option>
                    <option value="medium" {% if task.priority == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="low" {% if task.priority == 'low' %}selected{% endif %}>Low</option>
                </select>
                <button type="submit" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs font-semibold text-slate-100 transition">Priority</button>
            </form>
        </div>

        {% if task.resources %}
        <div class="mt-3">
            <p class="text-[11px] uppercase tracking-[0.12em] text-slate-500 mb-1">Linked Docs</p>
            <div class="flex flex-wrap gap-1">
                {% for resource in task.resources %}
                <a href="{{ resource.safe_link }}" target="_blank" rel="noopener noreferrer" class="text-[11px] px-2 py-1 rounded-full bg-blue-500/10 border border-blue-500/25 text-blue-200 hover:bg-blue-500/20 transition">{{ resource.title }}</a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </article>

    {% if task.ordered_subtasks %}
    <ul class="space-y-2">
        {% for child in task.ordered_subtasks %}
        {{ render_nested_task(child, view_mode, project_scope, depth + 1) }}
        {% endfor %}
    </ul>
    {% endif %}
</li>
{% endmacro %}

{% block content %}
<section class="mb-8">
    <h1 class="text-3xl md:text-4xl font-black text-white mb-3">Nested To-Do Board</h1>
    <p class="text-slate-400 max-w-3xl">Track project tasks with parent-child nesting and switch to a priority queue for fastest execution order.</p>
</section>

<section class="grid xl:grid-cols-[0.62fr_0.38fr] gap-5 mb-8">
    <article class="rounded-2xl border border-slate-800 bg-slate-900 p-5">
        <div class="flex flex-wrap items-center gap-2 mb-4">
            <a href="{{ url_for('main.internal_todos', view='nested', project_id=selected_project_id) if selected_project_id else url_for('main.internal_todos', view='nested') }}" class="px-4 py-2 rounded-full text-sm font-semibold transition {{ 'bg-blue-600 text-white' if view_mode == 'nested' else 'bg-slate-800 text-slate-200 hover:bg-slate-700' }}">Nested View</a>
            <a href="{{ url_for('main.internal_todos', view='priority', project_id=selected_project_id) if selected_project_id else url_for('main.internal_todos', view='priority') }}" class="px-4 py-2 rounded-full text-sm font-semibold transition {{ 'bg-blue-600 text-white' if view_mode == 'priority' else 'bg-slate-800 text-slate-200 hover:bg-slate-700' }}">Priority Queue</a>
            <a href="{{ url_for('main.internal_resources', project_id=selected_project_id) if selected_project_id else url_for('main.internal_resources') }}" class="px-4 py-2 rounded-full text-sm font-semibold transition bg-slate-800 text-slate-200 hover:bg-slate-700">Linked Docs</a>
        </div>

        <form method="get" action="{{ url_for('main.internal_todos') }}" class="grid sm:grid-cols-[auto_1fr_auto] gap-2 mb-4">
            <input type="hidden" name="view" value="{{ view_mode }}">
            <label class="sr-only" for="todo-project-scope">Project scope</label>
            <span class="px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 text-xs uppercase tracking-[0.12em] text-slate-400 inline-flex items-center">Scope</span>
            <select id="todo-project-scope" name="project_id" class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-blue-500 transition">
                <option value="">All projects</option>
                {% for project in projects %}
                <option value="{{ project.id }}" {% if selected_project_id and selected_project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs font-semibold text-slate-100 transition">Apply</button>
        </form>

        <div class="grid grid-cols-3 gap-3 mb-3">
            <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p class="text-xs text-slate-400 mb-1">High</p>
                <p class="text-xl font-black text-rose-300">{{ queue_counts.high }}</p>
            </div>
            <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p class="text-xs text-slate-400 mb-1">Medium</p>
                <p class="text-xl font-black text-amber-300">{{ queue_counts.medium }}</p>
            </div>
            <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p class="text-xs text-slate-400 mb-1">Low</p>
                <p class="text-xl font-black text-blue-300">{{ queue_counts.low }}</p>
            </div>
        </div>

        <div class="grid sm:grid-cols-4 gap-3">
            <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p class="text-xs text-slate-400 mb-1">Open Tasks</p>
                <p class="text-xl font-black text-white">{{ task_stats.open }}</p>
            </div>
            <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p class="text-xs text-slate-400 mb-1">Blocked</p>
                <p class="text-xl font-black text-amber-300">{{ task_stats.blocked }}</p>
            </div>
            <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p class="text-xs text-slate-400 mb-1">Due Soon</p>
                <p class="text-xl font-black text-blue-300">{{ task_stats.due_soon }}</p>
            </div>
            <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <p class="text-xs text-slate-400 mb-1">Overdue</p>
                <p class="text-xl font-black text-rose-300">{{ task_stats.overdue }}</p>
            </div>
        </div>
        <p class="text-xs text-slate-500 mt-3">Due soon threshold: {{ due_soon_cutoff.strftime('%d %b %Y') }}</p>
    </article>

    <article id="new-task" class="rounded-2xl border border-slate-800 bg-slate-900 p-5">
        <h2 class="text-lg font-bold text-white mb-4">Add Task or Subtask</h2>
        <form action="{{ url_for('main.internal_todo_add') }}" method="post" class="space-y-3" data-task-form>
            <input type="hidden" name="view_mode" value="{{ view_mode }}">
            <input type="hidden" name="project_scope" value="{{ selected_project_id if selected_project_id else '' }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="space-y-2">
                <label class="text-xs uppercase tracking-[0.12em] text-slate-400">Project</label>
                <select name="project_id" required class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:outline-none focus:border-blue-500 transition">
                    <option value="" disabled {% if not selected_project_id %}selected{% endif %}>Select project</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if selected_project_id and selected_project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-xs uppercase tracking-[0.12em] text-slate-400">Parent Task (optional)</label>
                <select name="parent_task_id" class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:outline-none focus:border-blue-500 transition">
                    <option value="">None (top-level task)</option>
                    {% for task in parent_task_options %}
                    <option value="{{ task.id }}">{{ task.project.name }} · {{ task.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-xs uppercase tracking-[0.12em] text-slate-400">Task Title</label>
                <input name="title" type="text" required class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:outline-none focus:border-blue-500 transition">
            </div>

            <div class="grid sm:grid-cols-2 gap-3">
                <div class="space-y-2">
                    <label class="text-xs uppercase tracking-[0.12em] text-slate-400">Assignee</label>
                    <input name="assignee" type="text" list="todo-assignee-options" value="{{ current_internal_user.full_name if current_internal_user else '' }}" required class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:outline-none focus:border-blue-500 transition">
                    <datalist id="todo-assignee-options">
                        {% for user in active_internal_users %}
                        <option value="{{ user.full_name }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div class="space-y-2">
                    <label class="text-xs uppercase tracking-[0.12em] text-slate-400">Due Date</label>
                    <input
                        name="due_date"
                        type="date"
                        value="{{ default_task_due_date.isoformat() }}"
                        data-task-due-date
                        class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:outline-none focus:border-blue-500 transition"
                    >
                    <div class="flex flex-wrap gap-1.5">
                        <button type="button" data-due-offset="1" class="px-2.5 py-1 text-[11px] rounded-full bg-slate-800 hover:bg-slate-700 text-slate-200 transition">+1 day</button>
                        <button type="button" data-due-offset="3" class="px-2.5 py-1 text-[11px] rounded-full bg-slate-800 hover:bg-slate-700 text-slate-200 transition">+3 days</button>
                        <button type="button" data-due-offset="7" class="px-2.5 py-1 text-[11px] rounded-full bg-slate-800 hover:bg-slate-700 text-slate-200 transition">+1 week</button>
                        <button type="button" data-due-offset="14" class="px-2.5 py-1 text-[11px] rounded-full bg-slate-800 hover:bg-slate-700 text-slate-200 transition">+2 weeks</button>
                    </div>
                </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-3">
                <div class="space-y-2">
                    <label class="text-xs uppercase tracking-[0.12em] text-slate-400">Priority</label>
                    <select name="priority" class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:outline-none focus:border-blue-500 transition">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-xs uppercase tracking-[0.12em] text-slate-400">Status</label>
                    <select name="status" class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-slate-100 focus:outline-none focus:border-blue-500 transition">
                        <option value="todo" selected>Todo</option>
                        <option value="in-progress">In Progress</option>
                        <option value="blocked">Blocked</option>
                        <option value="done">Done</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="w-full px-4 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold transition">Add to To-Do Board</button>
        </form>
    </article>
</section>

{% if view_mode == "priority" %}
<section class="rounded-2xl border border-slate-800 bg-slate-900 p-6" data-filter-root>
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <h2 class="text-xl font-bold text-white">Priority Queue</h2>
        <p class="text-xs uppercase tracking-[0.14em] text-slate-400">Showing <span data-filter-count>{{ queue_tasks|length }}</span> tasks</p>
    </div>

    <div class="grid md:grid-cols-[1fr_auto_auto_auto] gap-3 mb-5">
        <input type="search" data-filter-input placeholder="Filter this queue by task, assignee, project, or linked doc..." class="w-full bg-slate-950 border border-slate-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500 transition">
        <select data-filter-status class="w-full md:w-44 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-slate-200 focus:outline-none focus:border-blue-500 transition">
            <option value="all">All statuses</option>
            <option value="todo">Todo</option>
            <option value="in-progress">In Progress</option>
            <option value="blocked">Blocked</option>
            <option value="done">Done</option>
        </select>
        <select data-filter-stage class="w-full md:w-40 bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-slate-200 focus:outline-none focus:border-blue-500 transition">
            <option value="all">All priorities</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
        </select>
        <button type="button" data-filter-reset class="w-full md:w-auto px-4 py-2.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100 text-sm font-semibold transition">Reset</button>
    </div>

    {% if queue_tasks %}
    <div class="space-y-3">
        {% for task in queue_tasks %}
        <article class="rounded-xl border border-slate-800 bg-slate-950/80 p-4 card-hover" data-filter-item data-status="{{ (task.status or '')|lower }}" data-stage="{{ (task.priority or '')|lower }}" data-filter-text="{{ task.title }} {{ task.project.name }} {{ task.assignee }}{% for resource in task.resources %} {{ resource.title }}{% endfor %}">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-3">
                <div>
                    <p class="text-xs uppercase tracking-[0.12em] text-slate-500 mb-1">Queue #{{ loop.index }}</p>
                    <p class="text-white font-semibold">{{ task.title }}</p>
                    <p class="text-xs text-slate-400 mt-1">{{ task.project.name }} · {{ task.assignee }}{% if task.due_date %} · Due {{ task.due_date.strftime('%d %b %Y') }}{% endif %}</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs px-2.5 py-1 rounded-full {{ internal_priority_class(task.priority) }} bg-slate-900 border border-slate-700">{{ task.priority|title }}</span>
                    <span class="text-xs px-2.5 py-1 rounded-full {{ internal_status_class(task.status) }}">{{ task.status|replace('-', ' ')|title }}</span>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-2 mt-3">
                <form action="{{ url_for('main.internal_todo_update_status', task_id=task.id) }}" method="post" class="flex gap-2">
                    <input type="hidden" name="view_mode" value="{{ view_mode }}">
                    <input type="hidden" name="project_scope" value="{{ selected_project_id if selected_project_id else '' }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select name="status" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-200 focus:outline-none focus:border-blue-500 transition">
                        <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>Todo</option>
                        <option value="in-progress" {% if task.status == 'in-progress' %}selected{% endif %}>In Progress</option>
                        <option value="blocked" {% if task.status == 'blocked' %}selected{% endif %}>Blocked</option>
                        <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
                    </select>
                    <button type="submit" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs font-semibold text-slate-100 transition">Status</button>
                </form>
                <form action="{{ url_for('main.internal_todo_update_priority', task_id=task.id) }}" method="post" class="flex gap-2">
                    <input type="hidden" name="view_mode" value="{{ view_mode }}">
                    <input type="hidden" name="project_scope" value="{{ selected_project_id if selected_project_id else '' }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select name="priority" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-200 focus:outline-none focus:border-blue-500 transition">
                        <option value="high" {% if task.priority == 'high' %}selected{% endif %}>High</option>
                        <option value="medium" {% if task.priority == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="low" {% if task.priority == 'low' %}selected{% endif %}>Low</option>
                    </select>
                    <button type="submit" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs font-semibold text-slate-100 transition">Priority</button>
                </form>
            </div>

            {% if task.resources %}
            <div class="mt-3">
                <p class="text-[11px] uppercase tracking-[0.12em] text-slate-500 mb-1">Linked Docs</p>
                <div class="flex flex-wrap gap-1">
                    {% for resource in task.resources %}
                    <a href="{{ resource.safe_link }}" target="_blank" rel="noopener noreferrer" class="text-[11px] px-2 py-1 rounded-full bg-blue-500/10 border border-blue-500/25 text-blue-200 hover:bg-blue-500/20 transition">{{ resource.title }}</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </article>
        {% endfor %}
    </div>
    <p data-filter-empty class="hidden mt-5 text-sm text-slate-400">No queue tasks match the current filters.</p>
    {% else %}
    <p class="text-slate-400 text-sm">No open tasks in the priority queue.</p>
    {% endif %}
</section>
{% else %}
<section class="space-y-5">
    {% for project in visible_projects %}
    {% set root_tasks = top_level_tasks_by_project.get(project.id, []) %}
    <article class="rounded-2xl border border-slate-800 bg-slate-900 p-5">
        <div class="flex items-center justify-between gap-3 mb-4">
            <div>
                <h2 class="text-xl font-bold text-white">{{ project.name }}</h2>
                <p class="text-xs text-slate-400 mt-1">{{ project.client.name }} · {{ project.stage|title }}</p>
            </div>
            <span class="text-xs px-2.5 py-1 rounded-full {{ internal_status_class(project.status) }}">{{ project.status|replace('-', ' ')|title }}</span>
        </div>

        {% if project.resources %}
        <div class="mb-4">
            <p class="text-[11px] uppercase tracking-[0.12em] text-slate-500 mb-1">Project Docs</p>
            <div class="flex flex-wrap gap-1">
                {% for resource in project.resources %}
                <a href="{{ resource.safe_link }}" target="_blank" rel="noopener noreferrer" class="text-[11px] px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/25 text-emerald-200 hover:bg-emerald-500/20 transition">{{ resource.title }}</a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if root_tasks %}
        <ul class="space-y-2">
            {% for task in root_tasks %}
            {{ render_nested_task(task, view_mode, selected_project_id, 0) }}
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-sm text-slate-400">No tasks created for this project yet.</p>
        {% endif %}
    </article>
    {% else %}
    <article class="rounded-2xl border border-slate-800 bg-slate-900 p-5">
        <p class="text-sm text-slate-400">No projects available yet. Add a project before creating tasks.</p>
    </article>
    {% endfor %}
</section>
{% endif %}
{% endblock %}
